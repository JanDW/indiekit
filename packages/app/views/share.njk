{#-
  Share interface inspired and developed from an idea described by Max BÃ¶ck.
  See: https://mxb.dev/blog/indieweb-link-sharing/
-#}
{% from "preview/macro.njk" import preview %}

{% extends "_form.njk" %}

{% set title = "Share" %}
{% set bookmarkletFunction -%}
(function() {
  var title = document.getElementsByTagName('title')[0].innerHTML;
  name = encodeURIComponent(title);

  var selection = '';
  if (window.getSelection) {
    selection = window.getSelection().toString();
  } else if (document.selection && document.selection.type != 'Control') {
    selection = document.selection.createRange().text;
  }
  content = encodeURIComponent(selection);

  new_window=window.open(
    '{{ app.url }}/share/bookmarklet?name='+name+'&content='+content+'&url='+encodeURIComponent(document.location.href),
    'Sharer',
    'resizable,scrollbars,status=0,toolbar=0,menubar=0,titlebar=0,width=640,height=720,location=0'
  );
})();
{%- endset %}
{% set bookmarkletHref = "javascript:" + bookmarkletFunction | replace("  ", "") | replace("\n", "") | replace("&", "&amp;") | trim %}

{% block fieldset %}
  {{ preview({
    title: {
      text: __("Title"),
      for: "name",
      value: name
    },
    text: {
      text: __("Content"),
      for: "content",
      value: content
    },
    url: {
      text: __("URL"),
      for: "url",
      value: url
    },
    date: "now"
  }) }}

  {{ input({
    label: {
      text: __("Title")
    },
    id: "name",
    name: "name",
    value: name
  }) }}

  {{ textarea({
    label: {
      text: __("Content")
    },
    id: "content",
    name: "content",
    value: content
  }) | indent(8) }}

  {{ input({
    label: {
      text: __("URL")
    },
    id: "url",
    name: "bookmark-of",
    value: url
  }) }}

  {{ input({
    field: {
      classes: "visually-hidden"
    },
    type: "hidden",
    name: "access_token",
    value: session.token
  }) }}

  {{ input({
    field: {
      classes: "visually-hidden"
    },
    type: "hidden",
    name: "h",
    value: "entry"
  }) }}

  {{ button({
    text: __("Publish")
  }) }}

  <p><a href="{{ bookmarkletHref | safe }}">Bookmarklet</a></p>
{% endblock %}